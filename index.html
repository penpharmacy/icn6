<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report: IC Hand Hygiene Audit - โรงพยาบาลพุนพิน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; }
        .header-banner { background: linear-gradient(135deg, #1d976c, #93f9b9); color: white; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .section-title { border-left: 5px solid #1d976c; padding-left: 12px; margin-bottom: 15px; color: #1d976c; font-weight: bold; font-size: 1.1rem; }
        .dash-card { background: white; border-radius: 10px; padding: 12px; text-align: center; border: 1px solid #eee; height: 100%; }
        .dash-title { font-size: 1.1rem; color: #444; margin-bottom: 2px; font-weight: 700; }
        .dash-value { font-size: 1.4rem; font-weight: 800; display: block; line-height: 1.2; }
        .dash-fraction { font-size: 0.85rem; font-weight: 400; color: #888; display: block; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        h6.chart-label { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; color: #555; height: 2.4em; display: flex; align-items: center; justify-content: center; text-align: center; }
        .table { font-size: 0.82rem; }
        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #ddd; } }
        .table-matrix { width: auto !important; margin: 0 auto; min-width: 100%; }
        .table-matrix thead th { background-color: #2c3e50; color: white; border-color: #34495e; font-size: 0.75rem; padding: 8px 4px; }
        .table-matrix td { padding: 6px 2px !important; vertical-align: middle; line-height: 1.2; font-size: 0.75rem; }
        .bg-dept { background-color: #e8f6f3 !important; font-weight: bold; color: #16a085; border-right: 2px solid #d1d8e0 !important; border-bottom: 1px solid #ddd !important; }
        .bg-role { background-color: #f4f6f7 !important; font-weight: bold; color: #2c3e50; border-right: 2px solid #d1d8e0 !important; border-bottom: 1px solid #ddd !important; }
        .behavior-label { width: 60px; font-weight: bold; }
        .table-compliance-total { background-color: #f0fff4 !important; font-weight: bold; }
        .cell-pct { font-weight: bold; display: block; }
        .cell-frac { font-size: 0.65rem; color: #777; display: block; }
    </style>
</head>
<body>

<div class="header-banner text-center mb-3 no-print">
    <h4 class="fw-bold mb-0"><i class="fas fa-chart-line"></i> รายงานผล IC Hand Hygiene Audit โรงพยาบาลพุนพิน</h4>
</div>

<div class="container-fluid px-3">
    <div class="card p-2 no-print bg-light border mb-3">
        <div class="row align-items-end g-2 justify-content-center">
            <div class="col-md-3">
                <label class="form-label fw-bold small mb-1">รูปแบบการแสดงรายงาน</label>
                <select class="form-select form-select-sm" id="filterType" onchange="toggleFilterInputs()">
                    <option value="all">1. ข้อมูลทั้งหมด</option>
                    <option value="month">2. รายเดือน (ระบุเดือน/ปี)</option>
                    <option value="year">3. รายปี (ระบุปี)</option>
                    <option value="range">4. กำหนดช่วงวันที่</option>
                </select>
            </div>
            <div id="monthFilterGroup" class="col-md-2" style="display:none;"><label class="small mb-1">เลือกเดือน</label><input type="month" id="filterMonth" class="form-control form-control-sm"></div>
            <div id="yearFilterGroup" class="col-md-2" style="display:none;"><label class="small mb-1">ระบุปี (ค.ศ.)</label><input type="number" id="filterYear" class="form-control form-control-sm" placeholder="2026"></div>
            <div id="rangeFilterGroupStart" class="col-md-2" style="display:none;"><label class="small mb-1">จากวันที่</label><input type="date" id="filterStart" class="form-control form-control-sm"></div>
            <div id="rangeFilterGroupEnd" class="col-md-2" style="display:none;"><label class="small mb-1">ถึงวันที่</label><input type="date" id="filterEnd" class="form-control form-control-sm"></div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm w-100" onclick="updateReports()"><i class="fas fa-sync-alt"></i> อัปเดตข้อมูล</button>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">HW Overall</div><div class="dash-value text-primary" id="hw_val">0%</div><div class="dash-fraction" id="hw_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">HR Overall</div><div class="dash-value text-info" id="hr_val">0%</div><div class="dash-fraction" id="hr_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">Compliance Rate</div><div class="dash-value text-success" id="comp_val">0%</div><div class="dash-fraction" id="comp_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">ความพร้อมอุปกรณ์รวม</div><div class="dash-value text-warning" id="equip_val">0%</div><div class="dash-fraction" id="equip_frac">(0/0)</div></div></div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">สัดส่วนวิธีปฏิบัติภาพรวม</h6><div class="chart-container"><canvas id="pieChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">5 Moments (HR+HW)(%)</h6><div class="chart-container"><canvas id="momentChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">แนวโน้มความร่วมมือรายเดือน</h6><div class="chart-container"><canvas id="trendChart"></canvas></div></div></div>
    </div>

    <div class="text-end mb-4 no-print">
        <button class="btn btn-success btn-sm me-2" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
        <button class="btn btn-info btn-sm text-white" onclick="window.print()"><i class="fas fa-file-pdf"></i> พิมพ์ PDF</button>
    </div>

    <div id="reportArea">
        <div class="card p-3 mb-3">
            <h5 class="section-title">สรุป 5 Moments สำหรับการล้างมือ (ภาพรวม)</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-start">Moment</th>
                            <th class="table-success">HW + HR (Compliance %)</th>
                            <th>HW (%)</th>
                            <th>HR (%)</th>
                            <th>ไม่ล้าง (%)</th>
                            <th>ถุงมือ (%)</th>
                        </tr>
                    </thead>
                    <tbody id="momentTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <h5 class="section-title">สรุป 5 Moments แยกตามแผนก</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle table-matrix">
                    <thead>
                        <tr>
                            <th>แผนก</th>
                            <th class="behavior-label">พฤติกรรม</th>
                            <th>M1: ก่อนสัมผัส</th>
                            <th>M2: ก่อนหัตถการ</th>
                            <th>M3: หลังสารคัดหลั่ง</th>
                            <th>M4: หลังสัมผัสผู้ป่วย</th>
                            <th>M5: หลังสัมผัสสิ่งแวดล้อม</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <h5 class="section-title">สรุป 5 Moments แยกตามวิชาชีพ</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle table-matrix">
                    <thead>
                        <tr>
                            <th>วิชาชีพ</th>
                            <th class="behavior-label">พฤติกรรม</th>
                            <th>M1</th>
                            <th>M2</th>
                            <th>M3</th>
                            <th>M4</th>
                            <th>M5</th>
                        </tr>
                    </thead>
                    <tbody id="matrixRoleTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-6"><div class="card p-3"><h5 class="section-title">ภาพรวมแยกตามแผนก (%)</h5><table class="table table-bordered table-sm text-center"><thead class="table-light"><tr><th>แผนก</th><th>HW</th><th>HR</th><th>ไม่ล้าง</th><th>ถุงมือ</th></tr></thead><tbody id="deptTableBody"></tbody></table></div></div>
            <div class="col-md-6"><div class="card p-3"><h5 class="section-title">ภาพรวมแยกตามวิชาชีพ (%)</h5><table class="table table-bordered table-sm text-center"><thead class="table-light"><tr><th>วิชาชีพ</th><th>HW</th><th>HR</th><th>ไม่ล้าง</th><th>ถุงมือ</th></tr></thead><tbody id="roleTableBody"></tbody></table></div></div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx58a1xS-6se0SXJ_pyfPsk7wIPZlz9I6OGcksrA3ohJ9hkHloZVTbdD9a27HpbGK8QbQ/exec"; 
    let database = [];
    let charts = {};

    window.onload = fetchDataFromSheet;
    function fetchDataFromSheet() { fetch(SCRIPT_URL).then(res => res.json()).then(data => { database = data; updateReports(); }); }
    
    function toggleFilterInputs() {
        const type = document.getElementById('filterType').value;
        document.getElementById('monthFilterGroup').style.display = (type === 'month') ? 'block' : 'none';
        document.getElementById('yearFilterGroup').style.display = (type === 'year') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupStart').style.display = (type === 'range') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupEnd').style.display = (type === 'range') ? 'block' : 'none';
    }

    function updateReports() {
        const type = document.getElementById('filterType').value;
        let filtered = database;
        if (type === 'month') {
            const val = document.getElementById('filterMonth').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 7) === val);
        } else if (type === 'year') {
            const val = document.getElementById('filterYear').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 4) === val);
        } else if (type === 'range') {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            if (start && end) filtered = database.filter(d => { const dD = d.obsDate.substring(0, 10); return dD >= start && dD <= end; });
        }
        if (filtered.length === 0) { alert("ไม่พบข้อมูล"); resetDashboard(); return; }
        render(filtered);
    }

    function resetDashboard() {
        ['hw_val', 'hr_val', 'comp_val', 'equip_val'].forEach(id => document.getElementById(id).innerText = '0%');
        ['matrixTableBody', 'matrixRoleTableBody', 'momentTableBody', 'deptTableBody', 'roleTableBody'].forEach(id => document.getElementById(id).innerHTML = '');
        for (let key in charts) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }
    }

    function getPercentColor(pct) {
        let val = parseFloat(pct);
        if (val === 0) return 'text-danger fw-bold'; 
        if (val === 100) return 'text-success fw-bold';
        return ''; 
    }

    function render(data) {
        let hw = 0, hr = 0, none = 0, glove = 0, eqTotal = 0;
        let mStats = [
            {hw:0, hr:0, none:0, glove:0}, {hw:0, hr:0, none:0, glove:0}, 
            {hw:0, hr:0, none:0, glove:0}, {hw:0, hr:0, none:0, glove:0}, {hw:0, hr:0, none:0, glove:0}
        ];

        data.forEach(d => {
            if(d.m) d.m.forEach((v, i) => {
                if(v==='HW') { hw++; mStats[i].hw++; }
                else if(v==='HR') { hr++; mStats[i].hr++; }
                else if(v==='None') { none++; mStats[i].none++; }
                else if(v==='Glove') { glove++; mStats[i].glove++; }
            });
            if(d.equips) d.equips.forEach(v => eqTotal += v);
        });

        const totalOpp = hw + hr + none + glove; 
        
        document.getElementById('hw_val').innerText = ((hw / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('hw_frac').innerText = `(${hw}/${totalOpp})`;
        document.getElementById('hr_val').innerText = ((hr / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('hr_frac').innerText = `(${hr}/${totalOpp})`;
        document.getElementById('comp_val').innerText = (((hw + hr) / totalOpp) * 100).toFixed(1) + `%`;
        document.getElementById('comp_frac').innerText = `(${hw + hr}/${totalOpp})`;
        document.getElementById('equip_val').innerText = ((eqTotal / (data.length * 7)) * 100).toFixed(1) + `%`;
        document.getElementById('equip_frac').innerText = `(${eqTotal}/${data.length * 7})`;

        drawPie(hw, hr, none, glove);
        drawMomentBar(mStats);
        drawTrend(data);
        renderTables(data, mStats);
        renderMatrixGeneric(data, 'dept', 'matrixTableBody', 'bg-dept'); 
        renderMatrixGeneric(data, 'role', 'matrixRoleTableBody', 'bg-role');
    }

    // ฟังก์ชันสร้าง Matrix แบบรวม (ใช้ได้ทั้งแผนกและวิชาชีพ)
    function renderMatrixGeneric(data, field, bodyId, classLabel) {
        const body = document.getElementById(bodyId); 
        body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))].sort();
        const behaviors = [
            {k:'HW', l:'HW', c:'text-primary'},
            {k:'HR', l:'HR', c:'text-info'},
            {k:'None', l:'ไม่ล้าง', c:'text-danger'},
            {k:'Glove', l:'ถุงมือ', c:'text-warning'}
        ];

        keys.forEach(keyVal => {
            const filteredData = data.filter(d => d[field] === keyVal);
            
            behaviors.forEach((beh, bIdx) => {
                let row = `<tr>`;
                // ส่วนของชื่อกลุ่ม (แผนก/วิชาชีพ) แสดงแค่แถวแรกของกลุ่ม
                if (bIdx === 0) {
                    row += `<td rowspan="4" class="${classLabel} align-middle small">${keyVal}</td>`;
                }
                
                row += `<td class="text-start ps-1 fw-bold ${beh.c}">${beh.l}</td>`;
                
                // คำนวณแต่ละ Moment (1-5)
                for (let mIdx = 0; mIdx < 5; mIdx++) {
                    let count = filteredData.filter(d => d.m && d.m[mIdx] === beh.k).length;
                    let total = filteredData.filter(d => d.m && d.m[mIdx] && d.m[mIdx] !== "").length; // นับเฉพาะที่มีการประเมิน
                    
                    if (total > 0) {
                        let pct = ((count / total) * 100).toFixed(1);
                        row += `<td>
                            <span class="cell-pct ${getPercentColor(pct)}">${pct}%</span>
                            <span class="cell-frac">(${count}/${total})</span>
                        </td>`;
                    } else {
                        row += `<td class="text-muted small">-</td>`;
                    }
                }
                row += `</tr>`;
                body.innerHTML += row;
            });
            // เพิ่มเส้นคั่นระหว่างกลุ่มเพื่อความสวยงาม
            body.innerHTML += `<tr class="table-light"><td colspan="7" style="height:2px; padding:0;"></td></tr>`;
        });
    }

    function renderTables(data, mStats) {
        const mBody = document.getElementById('momentTableBody'); 
        mBody.innerHTML = '';
        const momentLabels = ["ก่อนสัมผัสผู้ป่วย", "ก่อนทำหัตถการ", "หลังสารคัดหลั่ง", "หลังสัมผัสผู้ป่วย", "หลังสัมผัสสิ่งรอบตัว"];
        
        momentLabels.forEach((l, idx) => {
            const m = mStats[idx];
            const total = m.hw + m.hr + m.none + m.glove;
            const fmt = (c) => { 
                if (total === 0 || c === 0) return "-"; 
                let pct = ((c/total)*100).toFixed(1); 
                return `<span class="${getPercentColor(pct)}">${pct}%</span> <br><small class="text-muted">(${c}/${total})</small>`; 
            };
            const hwHrSum = m.hw + m.hr;
            const fmtTotal = () => {
                if (total === 0 || hwHrSum === 0) return "-";
                let pct = ((hwHrSum / total) * 100).toFixed(1);
                return `<span class="fw-bold text-success">${pct}%</span> <br><small class="text-muted">(${hwHrSum}/${total})</small>`;
            };
            mBody.innerHTML += `<tr><td class="text-start fw-bold">${l}</td><td class="table-compliance-total">${fmtTotal()}</td><td>${fmt(m.hw)}</td><td>${fmt(m.hr)}</td><td>${fmt(m.none)}</td><td>${fmt(m.glove)}</td></tr>`;
        });

        renderTableFraction(data, 'dept', 'deptTableBody');
        renderTableFraction(data, 'role', 'roleTableBody');
    }

    function renderTableFraction(data, field, bodyId) {
        const body = document.getElementById(bodyId); body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))].sort();
        keys.forEach(k => {
            let f = data.filter(d => d[field] === k);
            let s = {HW:0, HR:0, None:0, Glove:0};
            f.forEach(d => { if(d.m) d.m.forEach(v => { if(v) s[v]++; }); });
            const total = s.HW + s.HR + s.None + s.Glove;
            const fmt = (c) => { 
                if (total === 0 || c === 0) return "0%";
                let pct = ((c/total)*100).toFixed(1); 
                return `<span class="${getPercentColor(pct)}">${pct}%</span> <br><small class="text-muted">(${c}/${total})</small>`; 
            };
            body.innerHTML += `<tr><td class="text-start ps-2 fw-bold">${k}</td><td>${fmt(s.HW)}</td><td>${fmt(s.HR)}</td><td>${fmt(s.None)}</td><td>${fmt(s.Glove)}</td></tr>`;
        });
    }

    // Chart functions (เหมือนเดิม)
    function drawPie(hw, hr, none, glove) { if(charts.pie) charts.pie.destroy(); charts.pie = new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: ['HW', 'HR', 'ไม่ล้างมือ', 'สวมถุงมือ'], datasets: [{ data: [hw, hr, none, glove], backgroundColor: ['#2ecc71', '#3498db', '#e74c3c', '#f1c40f'] }] }, options: { maintainAspectRatio: false } }); }
    function drawMomentBar(mStats) { 
        if(charts.moment) charts.moment.destroy(); 
        const scores = mStats.map(m => {
            const total = m.hw + m.hr + m.none + m.glove;
            return total > 0 ? (((m.hw + m.hr) / total) * 100).toFixed(1) : 0;
        });
        charts.moment = new Chart(document.getElementById('momentChart'), { type: 'bar', data: { labels: ["M1", "M2", "M3", "M4", "M5"], datasets: [{ label: 'Compliance (%)', data: scores, backgroundColor: '#1d976c' }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } }); 
    }
    function drawTrend(data) {
        if(charts.trend) charts.trend.destroy();
        const monthlyData = {};
        database.forEach(d => {
            if(!d.obsDate) return;
            const month = d.obsDate.substring(0, 7);
            if(!monthlyData[month]) monthlyData[month] = { pass: 0, total: 0 };
            if(d.m) d.m.forEach(v => { if(v){ monthlyData[month].total++; if(v === 'HW' || v === 'HR') monthlyData[month].pass++; } });
        });
        const labels = Object.keys(monthlyData).sort();
        charts.trend = new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Trend (%)', data: labels.map(l => ((monthlyData[l].pass / monthlyData[l].total) * 100).toFixed(1)), borderColor: '#1d976c', fill: true, backgroundColor: 'rgba(29, 151, 108, 0.1)' }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
    }

    function exportToExcel() {
        if(database.length === 0) return;
        const ws = XLSX.utils.json_to_sheet(database);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, "IC_HandHygiene_Report.xlsx");
    }
</script>
</body>
</html>
