<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report: IC Hand Hygiene Audit - โรงพยาบาลพุนพิน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; }
        .header-banner { background: linear-gradient(135deg, #1d976c, #93f9b9); color: white; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .section-title { border-left: 5px solid #1d976c; padding-left: 12px; margin-bottom: 15px; color: #1d976c; font-weight: bold; font-size: 1.1rem; }
        .dash-card { background: white; border-radius: 10px; padding: 12px; text-align: center; border: 1px solid #eee; height: 100%; }
        .dash-title { font-size: 1.1rem; color: #444; margin-bottom: 2px; font-weight: 700; }
        .dash-value { font-size: 1.4rem; font-weight: 800; display: block; line-height: 1.2; }
        .dash-fraction { font-size: 0.85rem; font-weight: 400; color: #888; display: block; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        h6.chart-label { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; color: #555; height: 2.4em; display: flex; align-items: center; justify-content: center; text-align: center; }
        .table { font-size: 0.82rem; }
        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #ddd; } }
        /* CSS เพิ่มเติมสำหรับ Matrix */
        .table-matrix thead th { background-color: #2c3e50; color: white; border-color: #34495e; }
        .bg-dept { background-color: #f8f9fa !important; font-weight: bold; }
        .bg-role { background-color: #f0f4f8 !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="header-banner text-center mb-3 no-print">
    <h4 class="fw-bold mb-0"><i class="fas fa-chart-line"></i> รายงานผล IC Hand Hygiene Audit โรงพยาบาลพุนพิน</h4>
</div>

<div class="container-fluid px-3">
    <div class="card p-2 no-print bg-light border mb-3">
        <div class="row align-items-end g-2 justify-content-center">
            <div class="col-md-3">
                <label class="form-label fw-bold small mb-1">รูปแบบการแสดงรายงาน</label>
                <select class="form-select form-select-sm" id="filterType" onchange="toggleFilterInputs()">
                    <option value="all">1. ข้อมูลทั้งหมด</option>
                    <option value="month">2. รายเดือน (ระบุเดือน/ปี)</option>
                    <option value="year">3. รายปี (ระบุปี)</option>
                    <option value="range">4. กำหนดช่วงวันที่ (เริ่ม - สิ้นสุด)</option>
                </select>
            </div>
            <div id="monthFilterGroup" class="col-md-2" style="display:none;"><label class="small mb-1">เลือกเดือน</label><input type="month" id="filterMonth" class="form-control form-control-sm"></div>
            <div id="yearFilterGroup" class="col-md-2" style="display:none;"><label class="small mb-1">ระบุปี (ค.ศ.)</label><input type="number" id="filterYear" class="form-control form-control-sm" placeholder="2026"></div>
            <div id="rangeFilterGroupStart" class="col-md-2" style="display:none;"><label class="small mb-1">จากวันที่</label><input type="date" id="filterStart" class="form-control form-control-sm"></div>
            <div id="rangeFilterGroupEnd" class="col-md-2" style="display:none;"><label class="small mb-1">ถึงวันที่</label><input type="date" id="filterEnd" class="form-control form-control-sm"></div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm w-100" onclick="updateReports()"><i class="fas fa-sync-alt"></i> อัปเดตข้อมูล</button>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">HW Overall</div><div class="dash-value text-primary" id="hw_val">0%</div><div class="dash-fraction" id="hw_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">HR Overall</div><div class="dash-value text-info" id="hr_val">0%</div><div class="dash-fraction" id="hr_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">Compliance Rate(HW+HR)</div><div class="dash-value text-success" id="comp_val">0%</div><div class="dash-fraction" id="comp_frac">(0/0)</div></div></div>
        <div class="col-md-3"><div class="dash-card"><div class="dash-title">ความพร้อมอุปกรณ์รวม</div><div class="dash-value text-warning" id="equip_val">0%</div><div class="dash-fraction" id="equip_frac">(0/0)</div></div></div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">สัดส่วนวิธีปฏิบัติภาพรวม</h6><div class="chart-container"><canvas id="pieChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">ความร่วมมือแยกตาม 5 Moments (HR+HW)(%)</h6><div class="chart-container"><canvas id="momentChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">แนวโน้มความร่วมมือรายเดือน(HR+HW)</h6><div class="chart-container"><canvas id="trendChart"></canvas></div></div></div>
        <div class="col-md-4"><div class="card p-2 h-100"><h6 class="chart-label">Compliance Rate รายแผนก(HR+HW)</h6><div class="chart-container"><canvas id="deptChart"></canvas></div></div></div>
        <div class="col-md-8"><div class="card p-2 h-100"><h6 class="chart-label text-warning"><i class="fas fa-tools me-2"></i>ความพร้อมใช้อุปกรณ์แยกตามแผนก (%)</h6><div class="chart-container"><canvas id="equipDeptChart"></canvas></div></div></div>
    </div>

    <div class="text-end mb-4 no-print">
        <button class="btn btn-success btn-sm me-2" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel (ข้อมูลพร้อมสรุป)</button>
        <button class="btn btn-info btn-sm text-white" onclick="window.print()"><i class="fas fa-file-pdf"></i> พิมพ์ PDF</button>
    </div>

    <div id="reportArea">
        <div class="card p-3 mb-3">
            <h5 class="section-title">Matrix: สรุปผล % 5 Moments แยกตามแผนกและพฤติกรรม</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle table-matrix">
                    <thead>
                        <tr>
                            <th style="width: 15%;">แผนก</th>
                            <th style="width: 12%;">พฤติกรรม</th>
                            <th>Moment 1</th>
                            <th>Moment 2</th>
                            <th>Moment 3</th>
                            <th>Moment 4</th>
                            <th>Moment 5</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <h5 class="section-title">Matrix: สรุปผล % 5 Moments แยกตามวิชาชีพและพฤติกรรม</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle table-matrix">
                    <thead>
                        <tr>
                            <th style="width: 15%;">วิชาชีพ</th>
                            <th style="width: 12%;">พฤติกรรม</th>
                            <th>Moment 1</th>
                            <th>Moment 2</th>
                            <th>Moment 3</th>
                            <th>Moment 4</th>
                            <th>Moment 5</th>
                        </tr>
                    </thead>
                    <tbody id="matrixRoleTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card p-3">
            <h5 class="section-title">สรุป 5 Moments สำหรับการล้างมือ</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center align-middle"><thead class="table-light"><tr><th class="text-start">Moment</th><th>HW (%)</th><th>HR (%)</th><th>ไม่ล้าง (%)</th><th>ถุงมือ (%)</th></tr></thead><tbody id="momentTableBody"></tbody></table>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-6"><div class="card p-3"><h5 class="section-title">แยกตามแผนก (%)</h5><table class="table table-bordered table-sm text-center"><thead class="table-light"><tr><th>แผนก</th><th>HW</th><th>HR</th><th>ไม่ล้าง</th><th>ถุงมือ</th></tr></thead><tbody id="deptTableBody"></tbody></table></div></div>
            <div class="col-md-6"><div class="card p-3"><h5 class="section-title">แยกตามวิชาชีพ (%)</h5><table class="table table-bordered table-sm text-center"><thead class="table-light"><tr><th>วิชาชีพ</th><th>HW</th><th>HR</th><th>ไม่ล้าง</th><th>ถุงมือ</th></tr></thead><tbody id="roleTableBody"></tbody></table></div></div>
        </div>

        <div class="card p-3">
            <h5 class="section-title">ความพร้อมใช้อุปกรณ์และสรุปกลุ่มน้ำยาแยกตามแผนก (%)</h5>
            <div class="row g-3">
                <div class="col-lg-9">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>แผนก</th><th>อ่างล้างมือ</th><th>สบู่เหลว</th><th>4% Chlorhexidine</th><th>Alcohol hand rub</th><th>กระดาษเช็ดมือ</th><th>โปสเตอร์แสดงวิธีการล้างมือ</th><th>ถังขยะใส่กระดาษเช็ดมือ</th>
                                </tr>
                            </thead>
                            <tbody id="equipTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle">
                            <thead class="table-light">
                                <tr class="table-primary">
                                    <th>แผนก</th>
                                    <th title="สบู่เหลว หรือ 4%CHG หรือ Alcohol อย่างใดอย่างหนึ่ง">สรุปกลุ่มน้ำยา*</th>
                                </tr>
                            </thead>
                            <tbody id="equipSummaryTableBody"></tbody>
                        </table>
                    </div>
                    <p style="font-size: 0.7rem;" class="text-muted">* สรุปกลุ่มน้ำยา: คำนวณจากมี สบู่เหลว หรือ 4%CHG หรือ Alcohol อย่างใดอย่างหนึ่งพร้อม</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx58a1xS-6se0SXJ_pyfPsk7wIPZlz9I6OGcksrA3ohJ9hkHloZVTbdD9a27HpbGK8QbQ/exec"; 
    let database = [];
    let charts = {};

    window.onload = fetchDataFromSheet;
    function fetchDataFromSheet() { fetch(SCRIPT_URL).then(res => res.json()).then(data => { database = data; updateReports(); }); }
    
    function toggleFilterInputs() {
        const type = document.getElementById('filterType').value;
        document.getElementById('monthFilterGroup').style.display = (type === 'month') ? 'block' : 'none';
        document.getElementById('yearFilterGroup').style.display = (type === 'year') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupStart').style.display = (type === 'range') ? 'block' : 'none';
        document.getElementById('rangeFilterGroupEnd').style.display = (type === 'range') ? 'block' : 'none';
    }

    function updateReports() {
        const type = document.getElementById('filterType').value;
        let filtered = database;
        if (type === 'month') {
            const val = document.getElementById('filterMonth').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 7) === val);
        } else if (type === 'year') {
            const val = document.getElementById('filterYear').value;
            if (val) filtered = database.filter(d => d.obsDate && d.obsDate.substring(0, 4) === val);
        } else if (type === 'range') {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            if (start && end) filtered = database.filter(d => { const dD = d.obsDate.substring(0, 10); return dD >= start && dD <= end; });
        }

        if (filtered.length === 0) {
            alert("ไม่พบข้อมูลในช่วงที่เลือก");
            resetDashboard();
            return;
        }

        render(filtered);
    }

    function resetDashboard() {
        ['hw_val', 'hr_val', 'comp_val', 'equip_val'].forEach(id => document.getElementById(id).innerText = '0%');
        ['hw_frac', 'hr_frac', 'comp_frac', 'equip_frac'].forEach(id => document.getElementById(id).innerText = '(0/0)');
        ['matrixTableBody', 'matrixRoleTableBody', 'momentTableBody', 'deptTableBody', 'roleTableBody', 'equipTableBody', 'equipSummaryTableBody'].forEach(id => {
            document.getElementById(id).innerHTML = '';
        });
        for (let key in charts) {
            if (charts[key]) {
                charts[key].destroy();
                charts[key] = null;
            }
        }
    }

    function getPercentColor(pct) {
        let val = parseFloat(pct);
        if (val === 0) return 'text-danger fw-bold'; 
        if (val === 100) return 'text-success fw-bold';
        return ''; 
    }

    function render(data) {
        let n = data.length; 
        let hw = 0, hr = 0, none = 0, glove = 0, eqTotal = 0;
        let mStats = [0,0,0,0,0];

        data.forEach(d => {
            if(d.m) d.m.forEach((v, i) => {
                if(v==='HW') { hw++; mStats[i]++; }
                else if(v==='HR') { hr++; mStats[i]++; }
                else if(v==='None') none++;
                else if(v==='Glove') glove++;
            });
            if(d.equips) d.equips.forEach(v => eqTotal += v);
        });

        document.getElementById('hw_val').innerText = ((hw / (n * 5)) * 100).toFixed(1) + `%`;
        document.getElementById('hw_frac').innerText = `(${hw}/${n * 5})`;
        document.getElementById('hr_val').innerText = ((hr / (n * 5)) * 100).toFixed(1) + `%`;
        document.getElementById('hr_frac').innerText = `(${hr}/${n * 5})`;
        document.getElementById('comp_val').innerText = (((hw + hr) / (n * 5)) * 100).toFixed(1) + `%`;
        document.getElementById('comp_frac').innerText = `(${hw + hr}/${n * 5})`;
        document.getElementById('equip_val').innerText = ((eqTotal / (n * 7)) * 100).toFixed(1) + `%`;
        document.getElementById('equip_frac').innerText = `(${eqTotal}/${n * 7})`;

        drawPie(hw, hr, none, glove);
        drawMomentBar(mStats, n);
        drawDeptBar(data);
        drawTrend(data);
        drawEquipDeptChart(data);
        renderTables(data, n);
        renderEquipTable(data);
        renderMatrixTable(data); 
        renderMatrixRoleTable(data); // เพิ่มการเรียกใช้ Matrix วิชาชีพ
    }

    function drawPie(hw, hr, none, glove) {
        if(charts.pie) charts.pie.destroy();
        charts.pie = new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: ['HW', 'HR', 'ไม่ล้างมือ', 'สวมถุงมือ'], datasets: [{ data: [hw, hr, none, glove], backgroundColor: ['#2ecc71', '#3498db', '#e74c3c', '#f1c40f'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } } });
    }
    function drawMomentBar(stats, n) {
        if(charts.moment) charts.moment.destroy();
        charts.moment = new Chart(document.getElementById('momentChart'), { type: 'bar', data: { labels: ["ก่อนสัมผัสผู้ป่วย", "ก่อนทำหัตถการปลอดเชื้อ", "หลังสัมผัสสารคัดหลั่งผู้ป่วย", "หลังสัมผัสผู้ป่วย", "หลังสัมผัสสิ่งรอบตัวผู้ป่วย"], datasets: [{ label: 'Compliance (%)', data: stats.map(s => ((s/n)*100).toFixed(1)), backgroundColor: '#1d976c', extraData: stats.map(s => `(${s}/${n})`) }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw}% ${ctx.dataset.extraData[ctx.dataIndex]}` } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } } } });
    }
    function drawDeptBar(data) {
        if(charts.dept) charts.dept.destroy();
        const depts = [...new Set(data.map(d => d.dept))];
        const rawScores = depts.map(dn => { let f = data.filter(d => d.dept === dn); let pass = f.reduce((acc, curr) => acc + curr.m.filter(v => v === 'HW' || v === 'HR').length, 0); let total = f.length * 5; return { pct: ((pass / total) * 100).toFixed(1), frac: `(${pass}/${total})` }; });
        charts.dept = new Chart(document.getElementById('deptChart'), { type: 'bar', data: { labels: depts, datasets: [{ label: 'Dept (%)', data: rawScores.map(r => r.pct), backgroundColor: '#48c6ef', extra: rawScores.map(r => r.frac) }] }, options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw}% ${ctx.dataset.extra[ctx.dataIndex]}` } } }, scales: { x: { beginAtZero: true, max: 100, ticks: { font: { size: 9 } } }, y: { ticks: { font: { size: 9 } } } } } });
    }
    function drawTrend(data) {
        if(charts.trend) charts.trend.destroy();
        const monthlyData = {};
        database.forEach(d => { if(!d.obsDate) return; const month = d.obsDate.substring(0, 7); if(!monthlyData[month]) monthlyData[month] = { pass: 0, total: 0 }; d.m.forEach(v => { monthlyData[month].total++; if(v === 'HW' || v === 'HR') monthlyData[month].pass++; }); });
        const labels = Object.keys(monthlyData).sort();
        charts.trend = new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Trend (%)', data: labels.map(l => ((monthlyData[l].pass / monthlyData[l].total) * 100).toFixed(1)), extra: labels.map(l => `(${monthlyData[l].pass}/${monthlyData[l].total})`), borderColor: '#1d976c', fill: true, backgroundColor: 'rgba(29, 151, 108, 0.1)', tension: 0.3 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw}% ${ctx.dataset.extra[ctx.dataIndex]}` } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } } } });
    }
    function drawEquipDeptChart(data) {
        if(charts.equip) charts.equip.destroy();
        const depts = [...new Set(data.map(d => d.dept))];
        const rawScores = depts.map(dn => { let f = data.filter(d => d.dept === dn); let totalPossible = f.length * 7; let actualAvailable = f.reduce((acc, curr) => acc + curr.equips.reduce((a, b) => a + b, 0), 0); return { pct: ((actualAvailable / totalPossible) * 100).toFixed(1), frac: `(${actualAvailable}/${totalPossible})` }; });
        charts.equip = new Chart(document.getElementById('equipDeptChart'), { type: 'bar', data: { labels: depts, datasets: [{ label: 'อุปกรณ์ (%)', data: rawScores.map(r => r.pct), backgroundColor: '#f39c12', extra: rawScores.map(r => r.frac) }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.raw}% ${ctx.dataset.extra[ctx.dataIndex]}` } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } } } });
    }

    // ฟังก์ชัน Matrix แยกตามแผนก (ห้ามแก้ไข)
    function renderMatrixTable(data) {
        const body = document.getElementById('matrixTableBody');
        body.innerHTML = '';
        const depts = [...new Set(data.map(d => d.dept))].sort();
        const behaviors = [
            { key: 'HW', label: 'HW', colorClass: 'text-primary' },
            { key: 'HR', label: 'HR', colorClass: 'text-info' },
            { key: 'None', label: 'ไม่ล้าง', colorClass: 'text-danger' },
            { key: 'Glove', label: 'สวมถุงมือ', colorClass: 'text-warning' }
        ];

        depts.forEach(dn => {
            const f = data.filter(d => d.dept === dn);
            const total = f.length;

            behaviors.forEach((beh, idx) => {
                let row = `<tr>`;
                if (idx === 0) row += `<td rowspan="4" class="bg-dept align-middle">${dn}</td>`;
                row += `<td class="text-start ps-2 fw-bold ${beh.colorClass}">${beh.label}</td>`;

                for (let mIdx = 0; mIdx < 5; mIdx++) {
                    let count = f.filter(d => d.m && d.m[mIdx] === beh.key).length;
                    let pctVal = (count / total) * 100;
                    let pctText = pctVal.toFixed(1);
                    let cellContent = ""; 
                    if (pctVal > 0) {
                        let textStyle = (pctVal === 100) ? "color: #198754; font-weight: bold;" : "";
                        cellContent = `<span style="${textStyle}">${pctText}%</span><br><span class="text-muted" style="font-size:0.7rem">(${count}/${total})</span>`;
                    }
                    row += `<td>${cellContent}</td>`;
                }
                row += `</tr>`;
                body.innerHTML += row;
            });
        });
    }

    // --- ฟังก์ชัน Matrix แยกตามวิชาชีพ (เพิ่มใหม่) ---
    function renderMatrixRoleTable(data) {
        const body = document.getElementById('matrixRoleTableBody');
        body.innerHTML = '';
        const roles = [...new Set(data.map(d => d.role))].sort();
        const behaviors = [
            { key: 'HW', label: 'HW', colorClass: 'text-primary' },
            { key: 'HR', label: 'HR', colorClass: 'text-info' },
            { key: 'None', label: 'ไม่ล้าง', colorClass: 'text-danger' },
            { key: 'Glove', label: 'สวมถุงมือ', colorClass: 'text-warning' }
        ];

        roles.forEach(rn => {
            const f = data.filter(d => d.role === rn);
            const total = f.length;

            behaviors.forEach((beh, idx) => {
                let row = `<tr>`;
                if (idx === 0) row += `<td rowspan="4" class="bg-role align-middle">${rn}</td>`;
                row += `<td class="text-start ps-2 fw-bold ${beh.colorClass}">${beh.label}</td>`;

                for (let mIdx = 0; mIdx < 5; mIdx++) {
                    let count = f.filter(d => d.m && d.m[mIdx] === beh.key).length;
                    let pctVal = (count / total) * 100;
                    let pctText = pctVal.toFixed(1);
                    
                    let cellContent = ""; 
                    if (pctVal > 0) {
                        let textStyle = (pctVal === 100) ? "color: #198754; font-weight: bold;" : "";
                        cellContent = `<span style="${textStyle}">${pctText}%</span><br><span class="text-muted" style="font-size:0.7rem">(${count}/${total})</span>`;
                    }
                    row += `<td>${cellContent}</td>`;
                }
                row += `</tr>`;
                body.innerHTML += row;
            });
        });
    }

    function renderTables(data, n) {
        const mBody = document.getElementById('momentTableBody'); 
        mBody.innerHTML = '';
        const momentLabels = ["ก่อนสัมผัสผู้ป่วย", "ก่อนทำหัตถการปลอดเชื้อ", "หลังสัมผัสสารคัดหลั่งผู้ป่วย", "หลังสัมผัสผู้ป่วย", "หลังสัมผัสสิ่งรอบตัวผู้ป่วย"];
        momentLabels.forEach((l, idx) => {
            let s = {HW:0, HR:0, None:0, Glove:0};
            data.forEach(d => { if(d.m) s[d.m[idx]]++; });
            const fmt = (c) => { let pct = ((c/n)*100).toFixed(1); let colorClass = getPercentColor(pct); return `<span class="${colorClass}">${pct}%</span> <span class="text-muted">(${c}/${n})</span>`; };
            mBody.innerHTML += `<tr><td class="text-start">${l}</td><td>${fmt(s.HW)}</td><td>${fmt(s.HR)}</td><td>${fmt(s.None)}</td><td>${fmt(s.Glove)}</td></tr>`;
        });
        renderTableFraction(data, 'dept', 'deptTableBody');
        renderTableFraction(data, 'role', 'roleTableBody');
    }

    function renderTableFraction(data, field, bodyId) {
        const body = document.getElementById(bodyId); body.innerHTML = '';
        const keys = [...new Set(data.map(d => d[field]))];
        keys.forEach(k => {
            let f = data.filter(d => d[field] === k);
            let s = {HW:0, HR:0, None:0, Glove:0};
            f.forEach(d => { if(d.m) d.m.forEach(v => s[v]++); });
            const total = f.length * 5;
            const fmt = (c) => { let pct = ((c/total)*100).toFixed(1); let colorClass = getPercentColor(pct); return `<span class="${colorClass}">${pct}%</span> <span class="text-muted">(${c}/${total})</span>`; };
            body.innerHTML += `<tr><td>${k}</td><td>${fmt(s.HW)}</td><td>${fmt(s.HR)}</td><td>${fmt(s.None)}</td><td>${fmt(s.Glove)}</td></tr>`;
        });
    }

    function renderEquipTable(data) {
        const body = document.getElementById('equipTableBody'); 
        const summaryBody = document.getElementById('equipSummaryTableBody'); 
        body.innerHTML = ''; summaryBody.innerHTML = '';
        const depts = [...new Set(data.map(d => d.dept))];
        depts.forEach(dn => {
            let f = data.filter(d => d.dept === dn);
            let row = `<tr><td class="text-start fw-bold" style="background-color: #f9f9f9;">${dn}</td>`;
            for(let i=0; i<7; i++) {
                let count = f.filter(d => d.equips && d.equips[i] === 1).length;
                let pct = ((count / f.length) * 100).toFixed(0);
                let colorClass = getPercentColor(pct);
                row += `<td><span class="${colorClass}">${pct}%</span><br><span style="font-size:0.7rem" class="text-muted">(${count}/${f.length})</span></td>`;
            }
            body.innerHTML += row + `</tr>`;
            let soapOrAlcoCount = f.filter(d => d.equips && (d.equips[1] === 1 || d.equips[2] === 1 || d.equips[3] === 1)).length;
            let summaryPct = ((soapOrAlcoCount / f.length) * 100).toFixed(0);
            summaryBody.innerHTML += `<tr><td class="text-start small fw-bold">${dn}</td><td class="table-info"><span class="${getPercentColor(summaryPct)}">${summaryPct}%</span><br><span style="font-size:0.7rem" class="text-muted">(${soapOrAlcoCount}/${f.length})</span></td></tr>`;
        });
    }

    function exportToExcel() {
        if(database.length === 0) { alert("ไม่มีข้อมูลสำหรับการส่งออก"); return; }
        const exportData = database.map(d => {
            const cpCount = d.m ? d.m.filter(v => v === 'HW' || v === 'HR').length : 0;
            const eqCount = d.equips ? d.equips.reduce((a, b) => a + b, 0) : 0;
            const hasSoapOrAlco = d.equips ? (d.equips[1] === 1 || d.equips[2] === 1 || d.equips[3] === 1) : false;
            return {
                "วันที่": d.obsDate || "", "แผนก": d.dept || "", "วิชาชีพ": d.role || "",
                "Moment 1": d.m ? d.m[0] : "", "Moment 2": d.m ? d.m[1] : "", "Moment 3": d.m ? d.m[2] : "", "Moment 4": d.m ? d.m[3] : "", "Moment 5": d.m ? d.m[4] : "",
                "Compliance (%)": ((cpCount/5)*100).toFixed(1), "Hand Hygiene (Score/Total)": `${cpCount}/5`,
                "กลุ่มน้ำยาล้างมือ (สรุป)": hasSoapOrAlco ? "พร้อม" : "ไม่พร้อม",
                "อุปกรณ์ 1 (อ่าง)": d.equips ? (d.equips[0] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 2 (สบู่)": d.equips ? (d.equips[1] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 3 (4%CHG)": d.equips ? (d.equips[2] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 4 (Alcohol)": d.equips ? (d.equips[3] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 5 (กระดาษ)": d.equips ? (d.equips[4] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 6 (โปสเตอร์)": d.equips ? (d.equips[5] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "อุปกรณ์ 7 (ถังขยะ)": d.equips ? (d.equips[6] === 1 ? "พร้อม" : "ไม่พร้อม") : "",
                "ความพร้อมอุปกรณ์รวม (%)": ((eqCount/7)*100).toFixed(1)
            };
        });
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "HandHygiene_Data");
        XLSX.writeFile(wb, "IC_HandHygiene_Full_Report.xlsx");
    }
</script>
</body>
</html>
